<div>

  <ol class="breadcrumb">
    <li>Type {{ ctrl.testRun.type }}</li>
    <li>
      <a ng-href="#/test-runs/{{ ctrl.testRun.id }}">
        Tir du {{ ctrl.testRun.date | niceDate }}
      </a>
    </li>
    <li>
      <a ng-href="#/test-runs/{{ ctrl.testRun.id }}/tags">Tags</a>
    </li>
    <li class="active">
      Tags
      {{ ctrl.tags | prefixAndJoin:'@':' ' }}
      {{ ctrl.excludedTags | prefixAndJoin:'~@':' ' }}
    </li>
  </ol>

  <h1>
    Tags
    {{ ctrl.tags | prefixAndJoin:'@':' ' }}
    {{ ctrl.excludedTags | prefixAndJoin:'~@':' ' }}
    <small>Tir du {{ ctrl.testRun.date | niceDate }}</small>
  </h1>

  <!-- Tag filters -->

  <hr>

  <form class="row">

    <div class="col-xs-5">
      <div class="input-group input-group-sm">
        <label for="tags" class="control-label input-group-addon">Tags inclus</label>
        <input type="text" class="form-control" id="tags"
               ng-model="ctrl.tagsInput">
      </div>
    </div>

    <div class="col-xs-5">
      <div class="input-group input-group-sm">
        <label for="excludedTags" class="control-label input-group-addon">Tags exclus</label>
        <input type="text" class="form-control" id="excludedTags"
               ng-model="ctrl.excludedTagsInput">
      </div>
    </div>

    <div class="col-xs-2">
      <button class="btn btn-default btn-sm btn-block" ng-click="ctrl.updateRouteForTags()">
        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
        Actualiser
      </button>
    </div>

  </form>

  <!-- Stats -->

  <hr>

  <h2>Avancement par scénario</h2>

  <tc-scenario-progress stats="ctrl.stats"></tc-scenario-progress>

  <!-- Features -->

  <hr>

  <h2>Fonctionnalités</h2>

  <table class="table table-striped table-bordered">
    <thead>
    <tr>
      <th class="col-md-1">Groupe</th>
      <th class="col-md-4">Fonctionnalité</th>
      <th class="col-md-1">Statut</th>
      <th class="col-md-1">Total</th>
      <th class="col-md-1">Succès</th>
      <th class="col-md-1">Échecs</th>
      <th class="col-md-1">En attente</th>
      <th class="col-md-1">Non joués</th>
      <th class="col-md-1">Analysés</th>
    </tr>
    </thead>
    <tbody>
    <tr
      ng-repeat="feature in ctrl.features | filter:ctrl.isFeatureDisplayable as filteredFeatures track by feature.id">
      <td>{{ feature.group }}</td>
      <td>
        <a ng-href="#/features/{{ feature.id }}" ng-click="ctrl.selectFeature(feature); $event.preventDefault(); $event.stopPropagation();">
          {{ feature.info.name }}
        </a>
      </td>
      <td>
        <tc-status status="feature.status"></tc-status>
      </td>
      <td><span class="badge">{{ feature.stats.count }}</span></td>
      <td><span class="badge">{{ feature.stats.statsByStatus['PASSED'] }}</span></td>
      <td><span class="badge">{{ feature.stats.statsByStatus['FAILED'] }}</span></td>
      <td><span class="badge">{{ feature.stats.statsByStatus['PENDING'] }}</span></td>
      <td><span class="badge">{{ feature.stats.statsByStatus['NOT_RUN'] }}</span></td>
      <td><span class="badge">{{ feature.stats.reviewedCount }}</span></td>
    </tr>
    </tbody>
    <tfoot ng-if="ctrl.features.length != filteredFeatures.length">
    <tr>
      <td class="warning" colspan="12" style="text-align: center">
        Attention : certains fonctionnalités sont masquées.
        <a href ng-click="ctrl.clearSelectedFeature()">Cliquez ici pour supprimer le filtre</a>
      </td>
    </tr>
    </tfoot>
  </table>

  <!-- Scénarii -->

  <hr>

  <h2>Scénarii</h2>

  <tc-scenario-filters filters="ctrl.scenarioFilters" on-update="ctrl.updateScenarioStoredFilters(filters)">
  </tc-scenario-filters>

  <table class="table table-striped table-bordered">
    <thead>
    <tr>
      <th class="col-md-4">Fonctionnalité</th>
      <th class="col-md-6">Scénario</th>
      <th class="col-md-1">Statut</th>
      <th class="col-md-1">Analysé</th>
    </tr>
    </thead>
    <tbody>
    <tr
      ng-repeat="scenario in ctrl.scenarii | filter:ctrl.isScenarioInSelectedFeature | filter:ctrl.isScenarioStatusSelected as filteredScenarii track by scenario.id">
      <td>
        <a ng-href="#/features/{{ scenario.feature.id }}">
          {{ scenario.feature.info.name }}
        </a>
      </td>
      <td>
        <a ng-href="#/scenarii/{{ scenario.id }}">
          <tc-element-info info="scenario.info"></tc-element-info>
        </a>
      </td>
      <td>
        <tc-status status="scenario.status"></tc-status>
      </td>
      <td>
        <span class="label label-success" ng-if="scenario.reviewed">Oui</span>
        <span class="label label-default" ng-if="!scenario.reviewed">Non</span>
      </td>
    </tr>
    </tbody>
    <tfoot ng-if="filteredScenarii.length != ctrl.scenarii.length">
    <tr>
      <td class="warning" colspan="3" style="text-align: center">
        Attention :
        <ng-pluralize count="ctrl.scenarii.length - filteredScenarii.length"
                      when="{ 'one': 'un scénario masqué', 'other': '{} scénarii masqués'}">
        </ng-pluralize>
      </td>
    </tr>
    </tfoot>
  </table>

</div>
